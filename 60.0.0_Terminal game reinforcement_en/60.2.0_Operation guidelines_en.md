## Instructions of PC Game Client Reinforcement Tool

The PC game client reinforcement tool reinforces games by calling `AutoPack.exe` and entering commands. After reinforcement, if the return code is 0, the reinforcement is successful; otherwise, the reinforcement fails. If a failure occurs during reinforcement, please troubleshoot as instructed in [Reinforcement Error Codes](#/doc-center/4388aeb824b2f77fcf72c5529b307bf9c47f1f42), and if the problem persists, please <a href="https://admin.qidian.qq.com/template/blue/mp/menu/qr-code-jump.html?linkType=0&env=ol&kfuin=2852167644&fid=28&key=d81ab0145faf07ade8b35f63efae4464&cate=1&type=16&ftype=1&_type=wpa&qidian=true" target="_blank">contact the customer service</a> for assistance.

## Preparations

You need to compress the following files used during reinforcement into an `input.zip` package (note: for more information on the parameters in "[ ]", please see Tool Parameter Description below):

1. The package must include the file to be reinforced and protected, which is generally the game's main program file, such as `game.exe`. Its path can be passed in to the [protect] parameter in the command line tool.
2. The package can include PE files to be encrypted and protected, such as `game.exe` and `Core\gamecore.dll`, whose paths can be passed in to the [vm] parameter in the command line tool. In addition, it also needs to include the corresponding .map or .pdb files of the PE files, such as `game.map` and `Core\gamecore.map`, as well as the configuration files generated by the TvmProtect configuration tool, such as `game.exe.tvmp` and `Core\gamecore.dll.tvmp`. For more information on the generation of specific encryption configuration files, please see Instructions of TvmProtect Configuration Tool below.
3. The package can contain multiple files for signature verification, such as `Core\gamecore.dll`, whose paths can be passed in to the [verify] parameter in the command line tool.
4. The package can contain the corresponding files for Unity game packaging. For the required files, please see Unity Game Packaging Mode below.

For example, the directory structure of the `input.zip` package generated in the **preparations** step is as shown below:

![](/docs/ACE-doc/60_shellservice-pc/20/1.png )

## Tool Call Method

```bash
AutoPack.exe --appid <appid> --protect <path> --vm <path> --verify <path> --unity <flag> 
--input <inputPath>  --output  <outPath>
```

The `input.zip` package generated in the **preparations** step is called in the command line tool as follows

```bash
AutoPack.exe --appid 111 --protect game.exe --vm game.exe;Core\gamecore.dll --verify 
Core\gamecore.dll --unity true --input "C:\input.zip"  --output  "C:\output.zip"
```

## Tool Parameter Description

You need to compress the following files used during reinforcement into an `input.zip` package (note: for more information on the parameters in "[ ]", please see Tool Parameter Description below):

| Parameter | Description | Required | Sample Value |
|------|------|------|------|
|[appid] | `appid` (Game ID(javascript:;)) required by the reinforcement service | Yes |--appid 111 |
|[protect] | Path of the file to be reinforced, which is generally an .exe file. It is a relative path in the `input.zip` package | Yes |--protect game.exe |
|[vm] | List of paths of the PE files to be encrypted and protected, which are separated by semi-colons (;) and are relative paths in the `input.zip` package | No |--vm game.exe;<br>Core\gamecore.dll |
|[verify] | List of paths of the files for signature verification, which are separated by semi-colons (;) and are relative paths in the `input.zip` package | No |--verify Core\gamecore.dll |
|[unity] | Whether to enable Unity protection for Unity games. To enable protection, enter `true`; otherwise, leave the field empty | No |--unity true |
|[input] | Complete path of the `input.zip` file packaged in the **preparations** step | Yes |--input "C:\input.zip" |
|[output] | Complete path for outputting the reinforced package | Yes |--output "C:\output.zip" |

## Instructions of TvmProtect Configuration Tool

**Directions**

1. Run the `ConfigTool.exe` file.
2. Make sure that there is a .map or .pdb file with the same name as the PE file to be encrypted and protected in its directory and then drag the PE file into the tool.
3. After inputting the file, a list of functions of this executable module will be displayed. You can select a function and obfuscate or virtualize it through the right-click menu or shortcut keys.
4. After the encryption configuration is saved, an .exe.tvmp file with the same name as the PE file will be generated in the same directory.

![](/docs/ACE-doc/60_shellservice-pc/20/2.png)

## Unity Game Packaging Mode

**Mono-Backend**

- Copy `mono-2.0-bdwgc.dll` under `MonoBleedingEdge/EmbedRuntime` or `mono.dll` under `Game_Data/Mono`.
- Copy `Assembly-CSharp.dll` under `Game_Data/Managed`.
- Copy `level0` under the `Game_Data` directory.
- Keep the original directory structure when copying files as shown below:

![](/docs/ACE-doc/60_shellservice-pc/20/3.png)

**IL2Cpp-Backend**

- Copy the `GameAssembly.dll` and `global-metadata.dat` files.

## Notes

### Compilation options

***PE header `FILEALIGN` option**

If you use the Visual Studio 2008 compiler, change the value of `FILEALIGN` to `0x1000` simply by adding `/FILEALIGN:0x1000` in **Linker** > **Command Line** > **Additional Options**. As reinforcement will add some segments after the PE file, if `FILEALIGN` is set to the default value `0x400`, an insufficient space will make it impossible to add sections.

***Do not use the `__declspec(thread)` feature in the DLL module**

On Windows XP, LoadLibrary does not support dynamic loading. If static TLS modules are used for the static links of the game, after reinforcement, such modules will be loaded dynamically, causing a load failure and direct crash of the game. If you want to use the TLS feature, we recommend you call APIs such as `TlsAlloc` to implement dynamic TLS. You can verify the configuration result by using CFF Explorer to check whether the TLS directory table exists (if the TLS directory table exists as shown below, the configuration is incorrect):

![](/docs/ACE-doc/60_shellservice-pc/20/4.png )

***Do not statically import the .Net component in the EXE module**<br/>
If you use Visual Studio 2015 or above, please add the compilation option `/Zc:threadSafeInit-` to remove the implicit addition of TLS from the complier. You can verify the configuration result as follows: the .exe file in the following figure cannot be reinforced, as it contains `.Net Directory`:

![](/docs/ACE-doc/60_shellservice-pc/20/5.png)

### Selection of VM encryption function

- Functions related to the protection solution itself, such as the function where the Antibot connection code resides
- Network protocol sending/receiving functions and other relevant functions
- Collision detection functions
- AI processing functions
- Resource encryption, decryption, and processing functions
- Damage calculation functions
- Item processing functions (pickup, drop, repair, etc.)
- Shop processing functions (entering/exiting shop, selling/purchasing items, etc.)
- Warehouse operation functions
- Quest system functions (accepting, completing, and aborting quests, etc.)
- Attack functions (common attacks and spells)
- Pathfinding functions (walking, etc.)
- Character login functions (selecting character, etc.)
- NPC interaction functions

### .map file generation method

Generate .map files in Microsoft Visual C++ as follows: select **Property Pages** > **Linker** > **Debug** > **Generate Map File** and set it to `Yes (/MAP)`.

![](/docs/ACE-doc/60_shellservice-pc/20/6.png)

MSDN document: https://docs.microsoft.com/zh-cn/cpp/build/reference/map-generate-mapfile

### Admin permission

**The reinforced game has driver protection, and the driver can be properly loaded only by the admin. Therefore, you need to run the game with admin permission as follows:**

1. If your development environment is Visual Studio 2008 or above, select **Property Pages** > **Linker** > **Manifest File** and set `UAC Execution Level` to `requireAdministrator` as shown below (Visual Studio 2008 is used here):
![](/docs/ACE-doc/60_shellservice-pc/20/7.png )

2. In other environments below Visual Studio 2008, you need to add a manifest to increase the permission level in the main program resource file of the game. For example, add a custom resource (resource typ=24, ID=1) with following content in the game project:

```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0">
<assemblyIdentity
  version="1.0.0.0"
  processorArchitecture="X86"
  name="axLaunch.exe.manifest"
  type="win32" />
 
<trustInfo xmlns="urn:schemas-microsoft-com:asm.v3">
  <security>
    <requestedPrivileges>
        <requestedExecutionLevel level="requireAdministrator" uiAccess="false"/>
    </requestedPrivileges>
  </security>
</trustInfo>
</assembly>
```

At this point, an `rt_manif.bin Rebuild` project will be added under `Resource Files`, and the admin permission can be obtained on Windows Vista/7/10 (with a shield on the icon).