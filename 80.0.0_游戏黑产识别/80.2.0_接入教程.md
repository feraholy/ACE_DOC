## 接入教程

**黑产风险识别服务以 cgi 方式提供，访问域名为：`https://service.gamesafe.qq.com/`，接口综述如下：**

```txt
1. 接口采用https协议，post方法。
2. content-type: application/json，charset=utf-8。
3. 请求所有参数全部在http body中进行传递。
4.响应体为json格式。
5.接口路由：/cgi-bin/game_credit_service。
```

**请求服务的接口需要参照下面给出的方法生成鉴权参数 Authorization 传递给服务端，服务端通过相同的方法来比对鉴权。**

## 一、接入步骤

**1、game_key注册**

首先需要利用控制台提供的[game_key](/#/console/overview)进行注册，拿到game_key唯一对应的[私钥PK](/#/console/overview)

**2、提供request body**

接口使用的是https协议，post方法，将如下表所示的公共参数置于https请求的body中

| 名称 | 类型 |  是否必填  |  描述  |
| ---- | ---- | ---- | ----- |
| service_name | string | 是 | 子服务名称，黑产风险识别服务对应的服务名为black_risk_identification |
| service_params | Json object | 是 | 子服务具体参数，json对象 |
	   
其中，黑产风险识别服务对应的service_params说明如下表所示，其中human_id的生成算法见《[产品FAQ](#/doc-center/0644750622aba96604b61430af6bb69f8792cbd9)》
	   
| 名称 | 类型 |  是否必填  |  描述  |
| ---- | ---- | ---- | ----- |
| device_id | string | 否 | 手机设备：IMEI/idfa |
| client_ip | string | 否 | 客户端ip，建议传递 |
| phone_num | string | 否 | 手机号，与phone_num_md5二选一传递即可 |
| human_id | string | 否 | 自然人id，通过身份证号等信息hash得出 |
| phone_num_md5 | string | 否 | 手机号md5，与phone_num二选一传递即可 |
| mac | string | 否 | PC设备mac号 |
| account_id | string | 否 | 账号ID |
	   
request body示例：
	   
```json
{
    "service_name": "black_risk_identification",
    "service_params": 
    {
        "device_id": "device_id",
        "client_ip": "**.***.***.**",
        "phone_num": "phone_num",
        "human_id": "human_id",
        "mac": "mac",
        "account_id": "account_id"
    }
}
```

**3、生成鉴权参数Authorization**

1）创建前缀字符串

- 前缀字符串（简称prefix）为用斜线 “/” 作为分隔符的一串字符串，生成公式为：tp_auth_v1/{sign_algorithm}/{game_key}/{timestamp}/{nonce}
- sign_algorithm：签名算法，tp_auth_v1使用的是sha256算法，填sha256
- game_key：控制台分配给厂商的game_key，利用该game_key注册黑产风险识别服务后可获得私钥PK，game_key与私钥PK是一一对应的
- timestamp：请求的时间戳。日期格式按照ISO8601标准表示，并需要使用UTC时间。格式为：yyyy-MM-ddTHH:mm:ssZ，5分钟内请求有效
- nonce：每次请求保持不同的随机字符串

2）hash request body

- request body指定为json格式，对body的json字符串做sha256 hash操作

3）生成最终签名前字符串

- tmp_str的生成公式为：prefix + "/" + sha256(body) + "/" + PK
- sha256(body)为步骤2)中计算的body的hash值
- PK为与game_key一一对应的私钥，需要经过注册后获取

4）生成签名与前缀字符串拼接的鉴权字符串

- 鉴权字符串(auth_str)的生成公式为：prefix + "/" + sha256(tmp_str)

5）使用以下其中一种方式生成 Authorization

- 方式A：将计算得出的auth_str置于Authorization header中，例如Authorization: tp_auth_v1/sha256/9a20b8a351d1e2b223b2c38127433f75/2020-05-11T13:51:25Z/asdfeg/68b70a50065789ef476eae625a22801c295e9df2082db331c2d256a0f14c8b9e
- 方式B：将计算得出的auth_str拼接到请求url中，例如https://service.gamesafe.qq.com/cgi-bin/game_credit_service?Authorization=tp_auth_v1/sha256/9a20b8a351d1e2b223b2c38127433f75/2020-05-11T13:51:25Z/asdfeg/68b70a50065789ef476eae625a22801c295e9df2082db331c2d256a0f14c8b9e

## 二、请求示例

**给出一个具体的请求示例如下：**

1、假设控制台给game_id = 19605分配的game_key为9a20b8a351d1e2b223b2c38127433f75，那么利用此game_key注册后将会得到一个与game_key唯一对应的私钥PK：xxxx，该私钥保存于控制台中

2、根据公共参数得到request body

3、根据步骤3:《生成鉴权参数Authorization》小节生成鉴权参数，得到最终的请求，发送至控制台，例如：

```json
curl --request POST
        --url https://service.gamesafe.qq.com/cgi-bin/game_credit_service
        --header 'authorization: tp_auth_v1/sha256/9a20b8a351d1e2b223b2c38127433f75/2020-06-15T08:09:32Z/asdfeg/68b70a50065789ef476eae625a22801c295e9df2082db331c2d256a0f14c8b9e'
        --header 'content-type: application/json'
        --data '{\n "service_name": "black_risk_identification",\n  "service_params":  {\n "device_id": "device_id",\n  "client_ip": "**.***.***.**",\n  "phone_num": "phone_num",\n  "human_id": "human_id",\n  "mac": "mac"\n  }\n}'

```

4、控制台使用同样的规则进行签名验证，验证通过则允许该请求，并提供相应的服务。

## 三、响应体

**黑产风险识别服务响应体如下，其中：**

- ret为接口的响应码，0对应请求正常，非0对应请求异常
- data为接口的响应体，为json格式
- risk_0x1为int类型的黑产风险等级，恶意等级的说明见《[产品FAQ](#/doc-center/0644750622aba96604b61430af6bb69f8792cbd9)》中的各恶意等级说明

```json
{
    "data": 
    {
        "risk_0x1": 5, // 对应 0 到 5 的黑产风险等级
    },
    "ret": 0, // 0 正常响应
}
```
