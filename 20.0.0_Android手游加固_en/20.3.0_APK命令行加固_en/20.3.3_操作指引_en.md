With the game security protection solution provided by ACE, when using the command line-based reinforcement tool, you should ensure that reinforcement is the final stage of application or game release. If you modify or package a reinforced APK or AAB file again, ACE cannot and shall not be liable for any losses or damages arising therefrom. Therefore, if you need to release packages through multiple channels and package your game again after reinforcement, you must first verify that your game can run normally.

## Precautions

We provide the following suggestions based on the currently used shell and Google developer policies:

1. Keep the .so files under each architecture consistent. If no .so files exist under an architecture, you should delete the architecture folder or add an .so file.
2. Keep the number of DEX methods far below 65,535 as stipulated by Google. If the number is close to the limit, you can choose to multidex.
3. Do not mix reinforcement solutions. If there are any conflicts, please block solutions for troubleshooting.
4. Do not upgrade minSdkVersion and targetSdkVersion arbitrarily. You need to upgrade as instructed in Google's official documentation.
5. Do not replace the signature certificate arbitrarily; otherwise, the replacement may fail to be installed.
6. Do not upload debugged .so files for shelling or release. Files with symbols have the risk of code leakage.
7. Do not select too many .so or .dll files for shelling (we recommend you select up to five files); otherwise, the performance may be compromised due to shelling.
8. Place the `application` declared in the application in the primary .dex file. If you use multidex, you can keep the file to retain it in the primary .dex file.
9. The .so file protection feature requires that the .so file to be reinforced contain the `.init_array` node. If this node doesn't exist, please contact the relevant personnel.
10. If a UE4 game fails to be reinforced when LLD is used, please troubleshoot as instructed in LLD Solution.

## Tool Description

The reinforcement and signing processes of the command line-based reinforcement tool can be integrated into the CI process, so you can automatically reinforce and sign a game with just one line of code.

The reinforcement feature supports .so file-exported table obfuscation, AAB reinforcement, custom shell version, detection of .dex and .so files in the `lib` directory (this feature is available only if full verification is enabled), `global-metadata.dat` encryption, and shell's protection for the anti-cheat SDK. You can download the <a href="#/tool-center">command line-based reinforcement tool</a> as needed for reinforcement.


**Note:**

1. This tool supports Android games.
2. This tool supports the following operating systems: Windows, macOS, and Linux (for Windows and Linux, both x86 and x64 tool editions are provided. Please confirm the PC OS configuration first and then select the corresponding tool edition).
3. This tool will authenticate the game first when running. ACE will grant a `.cert` game certificate for each game. If the downloaded tool package doesn't contain the corresponding game certificate, please contact the customer service to get one.
4. This tool provides two modes: custom reinforcement mode and App Bundle reinforcement mode.
5. Before calling this tool on macOS or Linux, please grant the corresponding permission to it first by running the following command in its directory:
    ```xml
    cd where_your_clientconsole_dir
    chmod -R 777 ./*
    ```

**Note on multi-channel packaging** (for the relevant scenarios of multi-channel packages, please see <a href="#/doc-center/41d6587b56ae94698669b6e692380c85018acffc">Game Multi-Channel Packaging Guide</a>.)

1. If you need to batch reinforce multiple game channel packages, you can write a script based on the pseudocode for batch operation at the end of the document (strongly recommended).
2. If you need to package a reinforced game for multiple channels, we recommend you use the custom reinforcement mode and cancel verification on the files modified for channels in the configuration file during reinforcement.

## Custom Reinforcement Mode

The custom reinforcement mode supports more features. You can modify and call the configuration file by yourself, encrypt specified .so and .dll files, and select full or partial verification on files as needed. By default, the files are not verified. In addition, you can also configure the signing information to make the game package automatically signed after reinforcement. If you want to select partial verification, please carefully read the risk description first.

**Call method:**

```cmd
cd where_your_clientconsole_dir
ClientConsole.exe -d <gameId> <apkpath> <outDir> <certPath> -c 
<configPath> -s <symbolpath>
```

**Parameter description:**

Parameter | Description
---|---
-d | Standard Edition (which is the default value and cannot be changed)
gameId | Game ID (registered in the console)
apkPath | Complete path of the APK file to be reinforced (which cannot contain Chinese characters)
outDir | Complete path of the reinforced output APK file (which cannot contain Chinese characters)
certPath | Certificate path of the corresponding game ID (the certificate name is `Game_ID.cert` and cannot contain Chinese characters)
-c | Call configuration file (which is the default option and cannot be changed)
configPath | `config` configuration file path, which cannot contain Chinese characters. Tag pairs in the configuration file must be placed on the same line, and the file extension must be .xml
-s | Call configuration file, which is optional and supports the `global-metadata.dat` runtime decryption feature
symbolpath | Path of the symbol file package generated along with `libil2cpp.so`. For the specific format of the `symbols.zip` file, please see <a href="#/doc-center/ce3c6bbe772ebd775a11b04a9ca2c5fab5edf79d">`global-metadata.dat` runtime decryption feature guide</a>

## App Bundle Reinforcement Mode

Android App Bundle is the latest dynamic APK packaging and componentization technology launched by Google, which can generate bundle files with the .aab extension. You can modify and call the configuration file and encrypt specified .so and .dll files. The App Bundle reinforcement mode on the client doesn't support partial verification, and files in the Application Bundle will be verified by default.

**Call method:**

```cmd
cd where_your_clientconsole_dir
ClientConsole.exe -a <gameId> <aabPath> <outDir> <certPath> -c 
<configPath> -s <symbolpath>
```

**Parameter description:**

Parameter | Description
---|---
-a | AppBundle edition (which is the default value and cannot be changed)
gameId | Game ID (registered in the console)
aabPath | Complete path of the AAB file to be reinforced (which cannot contain Chinese characters. The file size cannot exceed 500 MB)
outDir | Complete path of the reinforced output APK file (which cannot contain Chinese characters)
certPath | Certificate path of the corresponding game ID (the certificate name is `Game_ID.cert` and cannot contain Chinese characters)
-c | Call configuration file (which is the default option and cannot be changed)
configPath | `config` configuration file path, which cannot contain Chinese characters. Tag pairs in the configuration file must be placed on the same line, and the file extension must be .xml
-s | Call configuration file, which is optional and supports the `global-metadata.dat` runtime decryption feature
symbolpath | Path of the symbol file package generated along with `libil2cpp.so`. For the specific format of the `symbols.zip` file, please see <a href="#/doc-center/ce3c6bbe772ebd775a11b04a9ca2c5fab5edf79d">`global-metadata.dat` runtime decryption feature guide</a> |

**`config` configuration file format:**

```xml
<?xml version="1.0" encoding="utf-8"?>
<Config>
	<!--Server Tools Version, please use default value and modify it after 
    contacting with -->
	<TPVersion>2.6.15.20427.qos</TPVersion>
    <!--ToolPath:  tools location,default ClientConsole/tools or cut 
    this atrribute-->
    <ToolPath>.\tools</ToolPath>
    <!--TPSvrHost: provite  server host if you deploy a private svr. Use 
    official host when not set. -->
    <!--TPSvrHost>your_private_svr_host</TPSvrHost-->
    <!-- EncSo: so fileName that you want to encrypt, less than 5 files for 
    performance-->
    <EncSo>libmono.so</EncSo>
    <!-- Encrypt global-metadata requires configuring libil2cpp.so and 
    enable_globalmetadata_enc to true-->
    <EncSo>libil2cpp.so</EncSo>

    <EncSo>libGameCore.so</EncSo>
    <!-- EncDll: dll fileName that you wangt to encrypt, less than 5 files 
    for perfirmance-->
    <EncDll>Assembly-CSharp.dll</EncDll>
    <!-- Sign: information of keystore when using local sign-->
    <Sign>
        <sign-argument name = "keystorePath" value="your_keystore_absolute_path"/>
        <sign-argument name = "keypass" value="123456"/>
        <sign-argument name = "storepass" value="123456"/>
        <sign-argument name = "alianame" value="test"/>
        <sign-argument name = "v1SigningEnabled" value="true"/>
        <sign-argument name = "v2SigningEnabled" value="false"/>
        <sign-argument name = "v3SigningEnabled" value="false"/>
    </Sign>
    <!-- Encrypt global-metadata requires configuring il2cpp.so and 
    enable_globalmetadata_enc-->
    <extparams>{"enable_globalmetadata_enc":true,"is_use_application_name":false}</extparams>

    <FileCheck name= "root" action="+">    
    <!-- Default is partial verification, if you want full verification, just 
    comment the following two lines -->
    <selector name="assets" action="-"/>
    <selector name="res" action="-"/>
        <!-- The following is an example configuration, please edit as needed -->
        <!--selector name="assets/bin" action="-">
            <selector name="assets/bin/Data/Managed" action="+">
                    <selector name="assets/bin/Data/Managed/UnityEngine.dll" action="-"/>
                    <selector name="assets/bin/Data/Managed/System.dll" action="-"/>
            </selector>
            <selector name="assets/bin/Data/Resources" action="+"/>
        </selector>
        <selector name="res/layout" action="-">
            <selector name="res/layout/check_permission_layout.xml" action="+"/>
        </selector-->
    </FileCheck>
</Config>
```

**`config` configuration file description:**

Configuration Item | Description
---|---
TPVersion| Shell version, which is required
ToolPath| Complete absolute path of the `tools` directory without quotation marks. The operations of the command line-based reinforcement tool depend on the information of the `tools` directory in the tool package
EncSo| List of names of the .so files to be encrypted without quotation marks. We recommend you select only the .so files of the main game logic. If too many .so files are encrypted, the game performance will be affected
EncDll| List of names of the .dll files to be encrypted without quotation marks. We recommend you select main game logic scripts such as `Assembly.dll`
keystorePath| Absolute path of the key file, which is a string
keyPass| Key library password, which is a string
storePass| Store password, which is a string
aliaName| Alias, which is a string
v1SigningEnabled| Whether to use a v1 signature, which is a string and can only be `true` or `false`
v2SigningEnabled| Whether to use a v2 signature, which is a string and can only be `true` or `false`
v3SigningEnabled| Whether to use a v3 signature, which is a string and can only be `true` or `false`
enable_globalmetadata_enc| Whether to enable the `global-metadata.dat` encryption feature, which is enabled by default
is_use_application_name | Whether to use the application name as the key, which is disabled by default
action| Partial file verification. "+" indicates that the file is selected, while "-" indicates that the file isn't selected
selector name| Path of a file for partial verification, which cannot begin or end with "/" and must be strictly in an XML tree structure

**Note:**

***Note on `TPVersion`:**
We recommend you use the default version that comes with the command line-based reinforcement tool. If you want to use another version, please contact us.

***Note on the signature:**
If you use a local signature, you don't need to upload the certificate and certificate information; instead, you only need to enter the following signing information: `keystorePath`, `storePass`, `keyPass`, and `aliaName`
The signing method of the custom reinforcement mode keeps the signature versions before and after reinforcement consistent and doesn't require you to configure v1, v2, and v3. If the signing information is unspecified or incorrect, or the package to be reinforced isn't signed, the package will not be signed by default and needs to be manually signed after reinforcement.
The signing method of the App Bundle reinforcement mode uses a v1, v2, or v3 signature specifically, which will be determined by the game developer. If the signing information is unspecified or incorrect, or the package to be reinforced isn't signed, the package will not be signed by default and needs to be manually signed after reinforcement. Generally, .aab packages use only v1 signatures.

***Note on the list of files to be encrypted:**
If `EncSo` and `EncDll` are empty lists or not specified, the `libmono.so`, `libil2cpp.so`, `Assembly-CSharp.dll`, and `Assembly-CSharp-firstpass.dll` files will be encrypted by default.

***Note on `global-metadata.dat` encryption:**
The `enable_globalmetadata_enc` field is used to enable `global-metadata` encryption. If you don't need this feature, you can directly delete the corresponding field. Only reinforcement tool v2.6 supports this feature, which is enabled by default.

***Note on encryption key:**
The `is_use_application_name` field is used to use the application name as part of .so key decryption to enhance the defense effect and prevent application renaming and cracked package generation. To enable it, please configure `is_use_application_name:true`.

***Note on resource file list:**
If `FileCheck` in the configuration file of the custom reinforcement mode isn't specified, resource files will not be verified by default.
The App Bundle reinforcement mode doesn't support partial verification, so all files will be verified by default.

***Note on ultra-fast upload:**
The current version of the command line-based reinforcement tool has integrated the ultra-fast upload feature to simplify the network transfer content and improve the transfer speed while eliminating your need to upload a complete package.

***Note on verification file selection:**
In `FileCheck name`, the entire root node is verified by default, and "+" indicates that the file is selected, while "-" indicates not selected. If you want to cancel verification for a file under a node, you can add the `selector` tag to it. As shown in the sample configuration file, if the `assets/bin` directory isn't selected, and the `assets/bin/Data/Managed` directory is selected, then you can select all options under the directory, deselect the `UnityEngine.dll` and `System.dll` files under the directory, select `assets/bin/Data/Resources` and all subfiles in the directory, deselect `res/layout` and all subfiles in the directory, and select `check_permission_layout.xml` among all subfiles. (This is equivalent to operations in web-based reinforcement.)

![](/docs/ACE-doc/20_Android-shellservice/30/30/1.png )

## Common Returned Results

Parameter | Description
---|---
The shelling task was finished | The reinforcement task is completed
Shell failed for time out | The reinforcement task failed due to timeout
Configuration error | Configuration parsing error
Command line parameter error| Incorrect command line parameter
Shelling error| Shelling error
Local client error| Local client error
Server error| Server error

## Note on Risks of Partial Verification

The shell will not protect the files that are not selected for verification. When such files are modified by players, the shell will not process them. The relevant situations are as detailed below:

1. If the game logic-related binary files are not verified during reinforcement, players may modify them or replace them with a package that can generate cracked game features.
2. If the `class.dex` file isn't verified during reinforcement, players may delete some Java code. In this case, certain features may become unavailable after repackaging.
3. If the `class.dex` file isn't verified during reinforcement, players may modify the .dex file to load new .so files in order to modify the game logic to generate a package with cracked game features.


## Reinforcement Effect

The shell protects game resources in an all-around manner. Once a cheat writer performs operations on any game resources such as addition, deletion, or modification, it will immediately make the game quit. If a game uses the Anti-cheat SDK and Shell Service Solution at the same time, the anti-cheat forced quit protection feature is enabled by default; however, the quit request needs to get the `openid`; that is, the forced quit feature will take effect only after the game calls the `setuserinfo` API. If the game isn't logged in to for a long time, considering the registration duration of different games, the game will be forced to quit after about 5 minutes if not logged in to. You can download the [apktool here](https://ibotpeaches.github.io/Apktool/install/).

**Judging package reinforcement**
Check whether the corresponding architecture directory in the `lib` directory in the installation package contains the `libtprt.so` file, and if so, the installation package has been reinforced.

**Directions on forced quit verification after reinforcement**

```xml
1. apktool d apkPath; # Use the apktool to decompress the. apk file
2. apktool b apkPath; # Use the apktool to package the .apk file again
3. After the APK is signed again, install and run the game, and the shell will immediately force the game to quit.
```

**Judging the forced quit of reinforced package**

```bash
# Check whether the logcat information contains `cleanly(1-30)` information, such as `Process 15407 exited cleanly (30)`
adb shell 
su
logcat d|grep "cleanly"
```

## LLD Solution

If your UE4 game uses LLD and reinforcement fails, you need to contact the relevant personnel and modify `GameActivity.java.template` to move `System.loadLibrary("UE4")` to the last line in the `static` node as follows:

```c
static{
            //$${soLoadLibrary}$$
        System.loadLibrary("c++_shared");
        System.loadLibrary("UE4");
}
```

## Pseudocode for Batch Operation

**Note**

As shelling involves many I/O operations, taking the server CPU and network bandwidth into consideration, we recommend you enable no more than 10 concurrent threads (which can be adjusted based on the server performance) and use a thread pool to process a large number of installation packages in batches.

**Directory structure:**

![](/docs/ACE-doc/20_Android-shellservice/30/30/2.png )

```py
#/usr/local/bin/python3
import os
import threading
import time
import shutil
from contextlib import contextmanager
from multiprocessing import Pool

g_temp_out = os.path.realpath("./temp")

@contextmanager
def _cwd(path):
    #change workspace into multichannel
    saved_dir = os.getcwd()
    if path is not None:
        os.chdir(path)
    try:
        yield
    finally:
        os.chdir(saved_dir)

def get_timestamp():
    now = int(round(time.time()*1000))
    now = time.strftime('%Y%m%d%H%M%S',time.localtime(now/1000))
    return now

def shell_sub_main(apk_absolute_path):
    channal_name = get_timestamp() + "_" +
                    os.path.basename(apk_absolute_path).replace(".apk", "")
    workspace = os.path.join(g_temp_out, channal_name)
    if os.path.isdir(workspace):
        shutil.rmtree(workspace)
    os.makedirs(workspace)
    with _cwd(workspace):
        '''
        here run console command
        note:
        use Absolute Path in config!!!
        use Absolute Path in config!!!
        use Absolute Path in config!!!
        '''
        cmd = "client_absolute_path -d gameid" +
               "apk_absolute_path ./ cert_absolute_path -c config"
        os.system(cmd)

def shell_main():
    inDir = os.path.realpath("./in")
    files = os.listdir(inDir)
    tasks = []
    for fi in files:
        path = "%s/%s"%(inDir, fi)
        if fi.endswith(".apk"):
            tasks.append(path)
    pool = Pool(maxtasksperchild=1)
    pool.map(shell_sub_main, tasks)
    pool.close()
    pool.join()
    print("all over")

if __name__ == '__main__':
    shell_main()

```
